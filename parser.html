<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document PII Parser - Client-Side Processing</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 0;
    }

    .main-content {
      padding: 40px 30px;
    }

    .upload-section {
      text-align: center;
      margin-bottom: 40px;
    }

    .upload-section h2 {
      color: #4a5568;
      margin-bottom: 20px;
      font-size: 1.8rem;
      font-weight: 500;
    }

    .file-upload-wrapper {
      position: relative;
      display: inline-block;
      margin-bottom: 20px;
    }

    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 20px 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.1rem;
      min-width: 300px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .file-upload-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .file-upload-label svg {
      width: 24px;
      height: 24px;
    }

    .file-name {
      margin-top: 15px;
      padding: 10px 20px;
      background: #f7fafc;
      border-radius: 10px;
      color: #4a5568;
      font-weight: 500;
      display: none;
    }

    .upload-btn {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 50px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
    }

    .upload-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(72, 187, 120, 0.6);
    }

    .upload-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .supported-formats {
      margin-top: 20px;
      color: #718096;
      font-size: 0.9rem;
    }

    .supported-formats strong {
      color: #4a5568;
    }

    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .results-section {
      display: none;
      margin-top: 40px;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e2e8f0;
    }

    .results-title {
      color: #4a5568;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .download-btn {
      background: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%);
      color: white;
      text-decoration: none;
      padding: 12px 25px;
      border-radius: 25px;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(237, 100, 166, 0.4);
      cursor: pointer;
      border: none;
    }

    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(237, 100, 166, 0.6);
      text-decoration: none;
      color: white;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #718096;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .report-content {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 15px;
      padding: 25px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
      color: #495057;
    }

    .error-message {
      background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
      color: #c53030;
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      border-left: 5px solid #e53e3e;
    }

    .success-message {
      background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
      color: #2d7d42;
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      border-left: 5px solid #38a169;
    }

    .security-note {
      background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%);
      color: #2c5282;
      padding: 20px;
      border-radius: 15px;
      margin-top: 30px;
      border-left: 5px solid #3182ce;
    }

    .security-note h3 {
      margin-bottom: 10px;
      color: #2d3748;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 15px;
      }

      .header {
        padding: 30px 20px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .main-content {
        padding: 30px 20px;
      }

      .file-upload-label {
        min-width: 250px;
        padding: 18px 30px;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }

      .results-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîí Document PII Parser</h1>
      <p>Client-side PII detection and redaction - No server upload required!</p>
    </div>

    <div class="main-content">
      <div class="upload-section">
        <h2>Select Your Document</h2>
        
        <div class="file-upload-wrapper">
          <input type="file" id="fileInput" class="file-input" accept=".txt,.csv,.json" required>
          <label for="fileInput" class="file-upload-label">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            Choose Document
          </label>
        </div>
        
        <div id="fileName" class="file-name"></div>
        
        <button type="button" class="upload-btn" id="processBtn" disabled>
          üîç Scan for PII
        </button>

        <div class="supported-formats">
          <strong>Supported formats:</strong> PDF (.pdf), Text (.txt), CSV (.csv), JSON (.json)<br>
          <em>Processing happens entirely in your browser - files never leave your device!</em>
        </div>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Analyzing document for PII...</p>
      </div>

      <div class="results-section" id="resultsSection">
        <div class="results-header">
          <h3 class="results-title">üìä Analysis Results</h3>
          <button id="downloadBtn" class="download-btn" style="display:none;">
            üì• Download Redacted File
          </button>
        </div>

        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-number" id="entitiesFound">0</div>
            <div class="stat-label">PII Entities Found</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="charactersRedacted">0</div>
            <div class="stat-label">Characters Redacted</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="documentLength">0</div>
            <div class="stat-label">Document Characters</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="redactionPercentage">0%</div>
            <div class="stat-label">Redaction Rate</div>
          </div>
        </div>

        <div class="report-content" id="report"></div>
      </div>

      <div class="security-note">
        <h3>üõ°Ô∏è Privacy & Security</h3>
        <p>Your documents are processed entirely in your browser using JavaScript. No data is uploaded to any server, transmitted over the internet, or stored anywhere. All processing happens locally on your device for maximum privacy and security.</p>
      </div>
    </div>
  </div>

  <script src="parser.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const processBtn = document.getElementById('processBtn');
    const loading = document.getElementById('loading');
    const resultsSection = document.getElementById('resultsSection');
    const downloadBtn = document.getElementById('downloadBtn');

    let currentFile = null;
    let currentResults = null;
    let parser = new DocumentPIIParser();

    // File input handling
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        currentFile = file;
        fileName.textContent = `üìÑ ${file.name} (${formatFileSize(file.size)})`;
        fileName.style.display = 'block';
        processBtn.disabled = false;
      } else {
        currentFile = null;
        fileName.style.display = 'none';
        processBtn.disabled = true;
      }
    });

    // Process button handling
    processBtn.addEventListener('click', async function() {
      if (!currentFile) return;
      
      showLoading();
      
      try {
        const results = await parser.processDocument(currentFile);
        currentResults = results;
        showResults(results);
      } catch (error) {
        hideLoading();
        showError(error.message);
        console.error('Processing error:', error);
      }
    });

    // Download button handling
    downloadBtn.addEventListener('click', function() {
      if (currentResults && currentFile) {
        parser.downloadRedactedFile(currentResults.redactedText, currentFile.name);
      }
    });

    function showLoading() {
      loading.style.display = 'block';
      resultsSection.style.display = 'none';
      processBtn.disabled = true;
      processBtn.textContent = 'Processing...';
      
      // Reset stats to show processing state
      resetStats();
    }

    function hideLoading() {
      loading.style.display = 'none';
      processBtn.disabled = false;
      processBtn.textContent = 'üîç Scan for PII';
    }
    
    function resetStats() {
      document.getElementById('entitiesFound').textContent = '0';
      document.getElementById('charactersRedacted').textContent = '0';
      document.getElementById('documentLength').textContent = '0';
      document.getElementById('redactionPercentage').textContent = '0%';
    }

    function showResults(data) {
      hideLoading();
      
      // Update statistics with proper fallbacks and validation
      const entitiesFound = data.piiEntitiesFound || 0;
      const charactersRedacted = Math.max(0, data.charactersRedacted || 0);
      const documentLength = Math.max(1, data.originalLength || 0);
      
      // Ensure redacted characters never exceeds document length
      const validatedCharactersRedacted = Math.min(charactersRedacted, documentLength);
      
      // Calculate redaction percentage
      const redactionPercentage = documentLength > 0 
        ? ((validatedCharactersRedacted / documentLength) * 100).toFixed(1)
        : 0;
      
      document.getElementById('entitiesFound').textContent = entitiesFound;
      document.getElementById('charactersRedacted').textContent = formatNumber(validatedCharactersRedacted);
      document.getElementById('documentLength').textContent = formatNumber(documentLength);
      document.getElementById('redactionPercentage').textContent = redactionPercentage + '%';

      // Show report
      document.getElementById('report').textContent = data.report || 'No report available';

      // Show download button
      downloadBtn.style.display = 'inline-block';

      // Show results section
      resultsSection.style.display = 'block';
      
      // Scroll to results
      resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Show success message with proper pluralization
      if (entitiesFound > 0) {
        const entityText = entitiesFound === 1 ? 'entity' : 'entities';
        showMessage(`‚úÖ Successfully found and redacted ${entitiesFound} PII ${entityText}!`, 'success');
      } else {
        showMessage('‚úÖ No PII entities found in your document. Your document is clean!', 'success');
      }
      
      // Log data for debugging
      console.log('Processing results:', {
        entitiesFound,
        charactersRedacted: validatedCharactersRedacted,
        documentLength,
        redactionPercentage: redactionPercentage + '%',
        processingTime: data.processingTime,
        hasRedactedText: !!data.redactedText
      });
    }

    function showError(message) {
      showMessage('‚ùå Error: ' + message, 'error');
      resultsSection.style.display = 'none';
    }

    function showMessage(message, type) {
      // Remove existing messages
      const existingMessages = document.querySelectorAll('.error-message, .success-message');
      existingMessages.forEach(msg => msg.remove());

      // Create new message
      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
      messageDiv.textContent = message;

      // Insert after upload section
      const uploadSection = document.querySelector('.upload-section');
      uploadSection.parentNode.insertBefore(messageDiv, uploadSection.nextSibling);

      // Auto-remove success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.remove();
          }
        }, 5000);
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatNumber(num) {
      return num.toLocaleString();
    }
  </script>
</body>
</html>
